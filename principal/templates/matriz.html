{% extends "base.html" %}

{% block titulo %}TH | Hall de la fama{% endblock %}


{% block footerScripts %}
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyCOK5exbY-SG6W6cr-EoH2jv9llU2uOFyA&sensor=true"></script>
<script>
	var directionsDisplay;
	var directionsService = new google.maps.DirectionsService();
	var map;
	//var usuarios=[];
	var usuarios=[];
	{% for usuario in usuarios %}
		usuarios[{{forloop.counter0}}]=
			{id:{{forloop.counter0}},
			username:'{{usuario.username}}',
			px:{{ usuario.px|stringformat:"f" }},
			py:{{ usuario.py|stringformat:"f" }}
		};
	{% endfor %}		
	console.log(usuarios);
	

	

	$(document).ready(function() {
		initialize();
		getMatriz();
		$('.cell').hover(calcRoute);
		$('#id_modo').change(getMatriz);
	});

	function initialize() {
		directionsDisplay = new google.maps.DirectionsRenderer();
	
		var centro = new google.maps.LatLng(37.735261, -4.791666);
		var mapOptions = {
			center : centro,
			zoom : 9,
			mapTypeId : google.maps.MapTypeId.ROADMAP
		};
		map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
		directionsDisplay.setMap(map);
	}
	
	function getMatriz(){
		var modo=$('#id_modo').val();
		var url = 'http://maps.googleapis.com/maps/api/distancematrix/json?origins={% for usuario in usuarios %}{% if forloop.last %}{{ usuario.px|stringformat:"f" }},{{ usuario.py|stringformat:"f" }}{% else %}{{ usuario.px|stringformat:"f" }},{{ usuario.py|stringformat:"f" }}|{% endif %}{% endfor %}&destinations={% for usuario in usuarios %}{% if forloop.last %}{{ usuario.px|stringformat:"f" }},{{ usuario.py|stringformat:"f" }}{% else %}{{ usuario.px|stringformat:"f" }},{{ usuario.py|stringformat:"f" }}|{% endif %}{% endfor %}'+
		'&mode='+modo+'&language=es-ES&sensor=false';
		$.getJSON(url, function(data) {
			console.log(url);
			console.log(data);
		var items = [];
		$.each(data, function(key, val) {
			items.push('<li id="' + key + '">' + val + '</li>');
		});
		$('<ul/>', {
			'class': 'my-new-list',
			html: items.join('')
			}).appendTo('body');
		});
		
		tabla="<table><tr>";
		for (var user in usuarios){
			console.log(user);
			tabla+='<th>'+user.username+'</th>';
		}
		tabla+='</tr>';
		
		tabla+='</tabla>';
		console.log(tabla);
		return url;
	}

	function calcRoute(evt) {
		//console.log(getMatriz());
		var start = $(this).parent("sx").val()+','+$(this).parent("sy").val();
		var end =  $(this).parent("ex").val()+','+$(this).parent("ey").val();
		var transporte="google.maps.DirectionsTravelMode."+$('#id_modo').val();
	
		var request = {
			origin:start,
			destination:end,
			travelMode: transporte
		};
		directionsService.route(request, function(response, status) {
			if (status == google.maps.DirectionsStatus.OK) {
				directionsDisplay.setDirections(response);
			}
		});
	}

</script>
<style>
	#map_canvas img {
		max-width: none;
	}
</style>

{% block contenido %}
Ejemplo:
https://developers.google.com/maps/location-based-apps?hl=es
<br/>
{% endblock %}
<ul>
{% for usuario in usuarios %}
	<li>eee {{usuario.username}}</li>
{% endfor %}
</ul>

<div>
	
	<a class="cell">hola</a>
</div>

<select id="id_modo" name="modo">
	<option value="WALKING">A pie</option>
	<option value="DRIVING">Coche</option>
	<option value="BICYCLING">Bicicleta</option>
	<option value="TRANSIT">Transporte p√∫blico</option>
</select>
<div>
	<div id="map-canvas" style="width: 400px; height: 300px"></div>
</div>
{% endblock %}